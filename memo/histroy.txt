/* 2023/07/19 一通り動作完了
 *　　setlist.json選択メニュー、縦表示画面など、詳細はまだ
 *    wav再生時に時々エラー発生、ファイル開けない、SD中身消えるなど
 * 2023/07/30 表示モードをマルチタスク化してエラーなくなった(SDとディスプレイのSPI通信ぶつからないようにした)
 *　　親機子機の表示完成、フェーダー、外部ボタンで操作も
 *    ブラウン管表示確認がまだ
 * 2023/8/14 完成　V1.0
 *    ブラウン管表示確認完了、マニュアル作成完了
 * 
 * 2023/10/1 テレモロ実装開始　V1.1
 *    現状使っているシステムではBPM30 <> 184の間をボリュームで動かしています！
 *    BPM120の時は1秒間に8回点滅が起こる設定です。
 *    -> 120BPM=2BPS 四分音符を8回 0.125sec=125000usec タイマー値はその半分の62500usec
 *    -> 1000000/(timer値×2×4)*60=BPM
 *  
 *    専用タスクでテレモロ動作できた　Timer1追加　MP4の時だけテレモロタスク動かすようにするといい
 *    expand値を渡せるようにすること->program作成動作確認まだ
 *    コマンドでテレモロ指示できるように　ボタンを追加して、赤と青に　1次停止、トレモロを切り替えできるようにすること
 *    子機のI/Oでもテレモロできるようにする？（隠し動作）
 * 2023/12/24
 *    テレモロ動作はMP4のときしか動作しないのでモード限定せず
 *    テレモロ動作中もexpand動作可能
 *    Uartでコマンド送信してテレモロ動作確認OK、タイマー0はテレモロ動作なし(タイマー停止)
 *    テレモロ動作中の表示、親機のテレモロ指示はまだ
 * 2023/1/1
 *    子機テレモロ動作完成、親機テレモロ指示・表示作成
 *    動作中にリセットかかるときがある
 *      ->Core1でWDTリセットかかってるかも？　delayを増やす　発生なし
 *      ->念のため変数使用時にMutexで排他制御入れる　発生なし
 *      ->効果確認のため上記外すがリセットなし
 * 2023/1/6
 *    完成　テレモロ子機複数台に入れて動作チェック
 *    リセットかかることあるが再現せず
 *    V1.1でキープ
 * 
 * 2023/1/20
 *    V1.2でCRT表示ルーチンを他のタスクと同様にセマフォでメッセージ送って制御する
 * 　　V1.2 14時台
 *    リセットかかった　ファイルオープンでエラー起こってるとしたらどうなるか見てみる
 *    MP4 Open出来なかったらError表示して止まるようにした。
 *    存在しないファイル指定してエラーだしても黒い画面表示されるだけでリセットかからず
 * 
 *    DrawCRTをコア1で動作に変更とV1.0でも起こるかどうかも見てみる
 *    コア１で入らせてもリセットかかった（まだV1.0ではかからない）
 * 
 *    スタックサイズをすべて8192にする（変更前は4096)
 * 　　リセットかかった　メモ　F　S34->35　　（まだV1.0ではかからない）
 * 
 *  ※いくら対策しても完全にリセットかからないという保証はできないので
 * 　　定期的に親機からの情報を送信、子機リセットしてもコマンド受信して復帰できるようにした
 *    子機はすぐに立ち上がるようDelay省略
 * 
 *    シリアル受信バッファのサイズも関係してるかも　serialRecieveString.reserve(200);
 *    aruduinoのserial_rx_buffer_sizeは64byteなので、コマンド文字列が読めないときがある？
 * {"COMMAND":"set","SET":18,"A":19,"B":20,"C":21,"D":22,"E":23,"F":24,"G":25,"H":26}
 *    バッファサイズ広げることもできるがシステムの設定変えないといけないよう　　
 * 通信速度を遅くすれば間に合うようになるか　115200でも普通は間に合ってる　（連続送信したら読めないことがあるが100msecあければよめている）
 * 
 * 
 * 
 * https://teratail.com/questions/361229
 * 
 * platformioでログ記録、例外スタックトレースを読めるようにする
 * https://zenn.dev/hrko/scraps/fe7ff71382845e
 * 
 * backtraceの場所確認する方法
 * https://romly.com/blog/esp32_addr2line/
 * https://tech.fusic.co.jp/posts/2021-12-15-mruby-esp32-app-mirb/
 * 
 * log 14:31-
 * やはりtaskDrawCrtでエラーでているようだ。V1.0では一切リセットかからない。
 * (inlined by) taskDrawCrt(void*) at src/main.cpp:1609
 * 
 * 連続で描画しすぎなのでvTaskDelay(1)をvTaskDelay(15)にする;
 * log 1/21　14:55－の次14:59-
 * crtCanvas.pushRotateZoom でエラー発生
 * 
 * crtCanvasにアクセスしていないタイミングでbufferからデータ読み込むようにしたがエラー発生
 * mutexで排他制御でエラーなくなるか確認してみる（音は良くない）
 * そもそも動きがおかしいのでエラーでなくなるかも
 * 
 * taskDrawCrtのタスクにsetbufferコマンドもってきた　動作はする音もOK 4台でチェック
 * crtCanvas.setBuffer(buffer, 1, 
 * 
 * 1/28
 * 常時親機から現状送信するか、しないか
 * 常時送信する場合、子機でマニュアル操作した場合コマンド受信無効にする必要あり
 * 常時送信しない場合、フェーダーの位置情報はそのフェーダを操作するまで更新反映されない 
 * ⇒子機マニュアル操作する場合は通信不具合の対応なので、その後の受信無効でOK
 * 　状態が常時更新されるのは、子機再始動するときなど使いやすい
 * 動作OK
 * 
 * 画面表示用の関数をmainとは別のファイルにする
 * 　
 * 2/4
 * 子機マニュアル動作時のボタン表示追加
 * 完成
 *
 * 2/10　V1.1完成
 * コード整形して不要部分削除、コメント追加
 * SDカード書き込み
 *
 * 3/30　V1.1追加
 * JPEG表示の分解能アップ
 * 16bitの場合、横幅120→144に増やしても動作OK
 * 8bitの場合、横幅120→240に増やしても動作OK
 * 2種類のbinファイル作って切り替えられるようにする
 *
 * 5/4　V1.1追加
 * WAVファイル再生できないようになっていた。メモリ不足。
 *  taskDrawIniのスタックサイズを減らす
 * ボタンの応答がもう少し早いほうがいい
 *　フレームレート周期で2回ON検知は遅いので、チェック周期を速くする
 */
